<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OVH Credentials Configuration - Lab as Code</title>
    <script src="https://cdn.jsdelivr.net/npm/htmx.org@2.0.0/dist/htmx.min.js" integrity="sha384-LAnQFtNXh8s0hn9mOc8bezfn16i4Zo4y3i4dMT8PtV9yip8jGehR3RxCJrmHV11d" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="header-title">
                    <h1>OVH Credentials Configuration</h1>
                    <p class="subtitle">Configure your OVHcloud API credentials</p>
                </div>
                <div class="header-actions">
                    <a href="/admin" class="btn btn-secondary">
                        <span class="btn-icon">‚Üê</span> Back to Labs
                    </a>
                    <a href="/logout" class="logout-btn" title="Logout">
                        <span class="logout-icon">üö™</span>
                        <span class="logout-text">Logout</span>
                    </a>
                </div>
            </div>
        </header>

        <main>
            <div class="credentials-container">
                <div class="info-box">
                    <h3>‚ÑπÔ∏è About OVH Credentials</h3>
                    <p>These credentials will be stored in memory and used for all lab deployments. They will be cleared when the application restarts.</p>
                    <p><strong>Note:</strong> Credentials are not persisted to disk for security reasons.</p>
                </div>

                <form id="credentials-form" action="/api/ovh-credentials" method="POST" hx-post="/api/ovh-credentials" hx-target="#form-response" hx-swap="innerHTML" hx-indicator="#loading" hx-boost="false">
                    <div id="form-response"></div>
                    <div id="loading" class="htmx-indicator">
                        <div class="spinner"></div>
                        <p>Saving credentials...</p>
                    </div>

                    <div class="form-section">
                        <h2>OVH API Credentials</h2>
                        
                        <div class="form-group">
                            <label for="ovh_application_key">Application Key *</label>
                            <input type="password" id="ovh_application_key" name="ovh_application_key" required>
                            <small>Your OVHcloud application key</small>
                        </div>

                        <div class="form-group">
                            <label for="ovh_application_secret">Application Secret *</label>
                            <input type="password" id="ovh_application_secret" name="ovh_application_secret" required>
                            <small>Your OVHcloud application secret</small>
                        </div>

                        <div class="form-group">
                            <label for="ovh_consumer_key">Consumer Key *</label>
                            <input type="password" id="ovh_consumer_key" name="ovh_consumer_key" required>
                            <small>Your OVHcloud consumer key</small>
                        </div>

                        <div class="form-group">
                            <label for="ovh_service_name">Service Name (Project ID) *</label>
                            <input type="text" id="ovh_service_name" name="ovh_service_name" required>
                            <small>Your OVHcloud project ID (service name)</small>
                        </div>

                        <div class="form-group">
                            <label for="ovh_endpoint">OVH Endpoint *</label>
                            <select id="ovh_endpoint" name="ovh_endpoint" required>
                                <option value="ovh-eu">ovh-eu (Europe)</option>
                                <option value="ovh-us">ovh-us (United States)</option>
                                <option value="ovh-ca">ovh-ca (Canada)</option>
                            </select>
                            <small>Select your OVHcloud region endpoint</small>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">
                            <span class="btn-icon">üíæ</span> Save Credentials
                        </button>
                        <button type="button" id="btn-check" class="btn btn-secondary" onclick="checkCredentials()">
                            <span class="btn-icon">‚úì</span> Check Status
                        </button>
                    </div>
                </form>

                <div id="status-container" class="status-container" style="display: none;">
                    <h3>Current Status</h3>
                    <div id="status-content"></div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Check credentials status
        function checkCredentials() {
            const statusContainer = document.getElementById('status-container');
            const statusContent = document.getElementById('status-content');
            
            statusContainer.style.display = 'block';
            statusContent.innerHTML = '<p>Checking...</p>';
            
            fetch('/api/ovh-credentials')
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else if (response.status === 404) {
                        return { configured: false };
                    }
                    throw new Error('Failed to check credentials');
                })
                .then(data => {
                    if (data.configured) {
                        statusContent.innerHTML = `
                            <div class="success-message">
                                <h4>‚úÖ Credentials Configured</h4>
                                <p>OVH credentials are stored in memory and ready to use.</p>
                                <ul>
                                    <li>Service Name: <strong>${data.service_name || 'N/A'}</strong></li>
                                    <li>Endpoint: <strong>${data.endpoint || 'N/A'}</strong></li>
                                </ul>
                                <p><small>Note: Credentials are stored in memory only and will be cleared on application restart.</small></p>
                            </div>
                        `;
                    } else {
                        statusContent.innerHTML = `
                            <div class="error-message">
                                <h4>‚ö†Ô∏è No Credentials Configured</h4>
                                <p>Please configure your OVH credentials above before creating labs.</p>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    statusContent.innerHTML = `
                        <div class="error-message">
                            <h4>‚ùå Error</h4>
                            <p>${error.message}</p>
                        </div>
                    `;
                });
        }

        // Load current credentials into form if they exist
        function loadCurrentCredentials() {
            fetch('/api/ovh-credentials')
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    }
                    return { configured: false };
                })
                .then(data => {
                    if (data.configured) {
                        // Pre-fill non-sensitive fields
                        const serviceNameInput = document.getElementById('ovh_service_name');
                        const endpointSelect = document.getElementById('ovh_endpoint');
                        
                        if (serviceNameInput && data.service_name) {
                            serviceNameInput.value = data.service_name;
                        }
                        
                        if (endpointSelect && data.endpoint) {
                            endpointSelect.value = data.endpoint;
                        }
                        
                        // Show info that credentials exist
                        const formSection = document.querySelector('.form-section');
                        if (formSection) {
                            const existingInfo = document.createElement('div');
                            existingInfo.className = 'info-box';
                            existingInfo.style.marginBottom = '1.5rem';
                            existingInfo.innerHTML = `
                                <h3>üìù Update Existing Credentials</h3>
                                <p>Credentials are currently configured. Fill in the fields below to update them.</p>
                                <p><strong>Service Name:</strong> ${data.service_name || 'N/A'}</p>
                                <p><strong>Endpoint:</strong> ${data.endpoint || 'N/A'}</p>
                            `;
                            formSection.insertBefore(existingInfo, formSection.firstChild);
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading credentials:', error);
                });
        }

        // Check status on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkCredentials();
            loadCurrentCredentials();
        });

        // Handle form submission success
        document.body.addEventListener('htmx:afterSwap', function(event) {
            if (event.detail.target.id === 'form-response') {
                const response = event.detail.target;
                const responseText = response.innerHTML.toLowerCase();
                if (responseText.includes('success') || responseText.includes('saved successfully')) {
                    // Refresh status after successful save
                    setTimeout(checkCredentials, 500);
                    // Clear form fields after successful save
                    document.getElementById('credentials-form').reset();
                }
            }
        });

        // Also handle HTMX errors to prevent navigation
        document.body.addEventListener('htmx:responseError', function(event) {
            console.error('HTMX Error:', event.detail);
            const responseDiv = document.getElementById('form-response');
            if (responseDiv) {
                responseDiv.innerHTML = `
                    <div class="error-message">
                        <h3>Error</h3>
                        <p>Failed to save credentials. Please check the server logs for details.</p>
                    </div>
                `;
            }
            // Prevent default error handling that might cause navigation
            event.preventDefault();
            return false;
        });

        // Fallback form submission if HTMX is not available
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('credentials-form');
            if (form) {
                form.addEventListener('submit', function(e) {
                    // If HTMX is not loaded, use fallback submission
                    if (typeof htmx === 'undefined') {
                        e.preventDefault();
                        
                        const formData = new FormData(form);
                        const responseDiv = document.getElementById('form-response');
                        const loadingDiv = document.getElementById('loading');
                        
                        // Show loading indicator
                        if (loadingDiv) {
                            loadingDiv.style.display = 'block';
                        }
                        
                        // Submit form via fetch
                        fetch('/api/ovh-credentials', {
                            method: 'POST',
                            body: formData
                        })
                        .then(response => response.text())
                        .then(html => {
                            if (responseDiv) {
                                responseDiv.innerHTML = html;
                            }
                            if (loadingDiv) {
                                loadingDiv.style.display = 'none';
                            }
                            
                            // Check if save was successful
                            const responseText = html.toLowerCase();
                            if (responseText.includes('success') || responseText.includes('saved successfully')) {
                                // Refresh status after successful save
                                setTimeout(checkCredentials, 500);
                                // Clear form fields after successful save
                                form.reset();
                            }
                        })
                        .catch(error => {
                            console.error('Error submitting form:', error);
                            if (responseDiv) {
                                responseDiv.innerHTML = `
                                    <div class="error-message">
                                        <h3>Error</h3>
                                        <p>Failed to save credentials: ${error.message}</p>
                                    </div>
                                `;
                            }
                            if (loadingDiv) {
                                loadingDiv.style.display = 'none';
                            }
                        });
                        
                        return false;
                    }
                    // Let HTMX handle the submission if available
                });
            }
        });
    </script>
</body>
</html>

