<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Provider Credentials Configuration - Lab as Code</title>
    <script src="https://cdn.jsdelivr.net/npm/htmx.org@2.0.0/dist/htmx.min.js" integrity="sha384-LAnQFtNXh8s0hn9mOc8bezfn16i4Zo4y3i4dMT8PtV9yip8jGehR3RxCJrmHV11d" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="header-title">
                    <h1>Provider Credentials Configuration</h1>
                    <p class="subtitle">Configure your cloud provider API credentials</p>
                </div>
                <div class="header-actions">
                    <a href="/jobs" class="header-btn" title="Jobs History">
                        <span class="btn-icon">üìã</span>
                        <span class="btn-text">Jobs</span>
                    </a>
                    <a href="/admin" class="btn btn-secondary">
                        <span class="btn-icon">‚Üê</span> Back to Labs
                    </a>
                    <a href="/logout" class="logout-btn" title="Logout">
                        <span class="logout-icon">üö™</span>
                        <span class="logout-text">Logout</span>
                    </a>
                </div>
            </div>
        </header>

        <main>
            <div class="credentials-container">
                <div class="info-box">
                    <h3>‚ÑπÔ∏è About Provider Credentials</h3>
                    <p>These credentials will be stored in memory and used for all lab deployments. They will be cleared when the application restarts.</p>
                    <p><strong>Note:</strong> Credentials are not persisted to disk for security reasons.</p>
                </div>

                <!-- Provider Selector -->
                <div class="form-group" style="margin-bottom: 2rem;">
                    <label for="provider-select">Select Provider</label>
                    <select id="provider-select" onchange="switchProvider()">
                        <option value="ovh">OVHcloud</option>
                        <!-- Future providers can be added here:
                        <option value="aws">Amazon Web Services (AWS)</option>
                        <option value="azure">Microsoft Azure</option>
                        <option value="gcp">Google Cloud Platform (GCP)</option>
                        -->
                    </select>
                    <small>Choose the cloud provider to configure credentials for</small>
                </div>

                <!-- OVH Provider Section -->
                <div id="provider-section-ovh" class="provider-section">
                    <form id="credentials-form-ovh" action="/api/credentials" method="POST" enctype="application/x-www-form-urlencoded" hx-post="/api/credentials" hx-target="#form-response-ovh" hx-swap="innerHTML" hx-indicator="#loading-ovh" hx-boost="false">
                        <input type="hidden" name="provider" value="ovh">
                        <div id="form-response-ovh"></div>
                        <div id="loading-ovh" class="htmx-indicator">
                            <div class="spinner"></div>
                            <p>Saving credentials...</p>
                        </div>

                        <div class="form-section">
                            <h2>OVH API Credentials</h2>
                            
                            <div class="form-group">
                                <label for="ovh_application_key">Application Key *</label>
                                <input type="password" id="ovh_application_key" name="ovh_application_key" required>
                                <small>Your OVHcloud application key</small>
                            </div>

                            <div class="form-group">
                                <label for="ovh_application_secret">Application Secret *</label>
                                <input type="password" id="ovh_application_secret" name="ovh_application_secret" required>
                                <small>Your OVHcloud application secret</small>
                            </div>

                            <div class="form-group">
                                <label for="ovh_consumer_key">Consumer Key *</label>
                                <input type="password" id="ovh_consumer_key" name="ovh_consumer_key" required>
                                <small>Your OVHcloud consumer key</small>
                            </div>

                            <div class="form-group">
                                <label for="ovh_service_name">Service Name (Project ID) *</label>
                                <input type="text" id="ovh_service_name" name="ovh_service_name" required>
                                <small>Your OVHcloud project ID (service name)</small>
                            </div>

                            <div class="form-group">
                                <label for="ovh_endpoint">OVH Endpoint *</label>
                                <select id="ovh_endpoint" name="ovh_endpoint" required>
                                    <option value="ovh-eu">ovh-eu (Europe)</option>
                                    <option value="ovh-us">ovh-us (United States)</option>
                                    <option value="ovh-ca">ovh-ca (Canada)</option>
                                </select>
                                <small>Select your OVHcloud region endpoint</small>
                            </div>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">
                                <span class="btn-icon">üíæ</span> Save Credentials
                            </button>
                            <button type="button" id="btn-check-ovh" class="btn btn-secondary" onclick="checkCredentials('ovh')">
                                <span class="btn-icon">‚úì</span> Check Status
                            </button>
                        </div>
                    </form>

                    <div id="status-container-ovh" class="status-container" style="display: none;">
                        <h3>Current Status</h3>
                        <div id="status-content-ovh"></div>
                    </div>
                </div>

                <!-- AWS Provider Section (Future) -->
                <div id="provider-section-aws" class="provider-section" style="display: none;">
                    <form id="credentials-form-aws" action="/api/credentials" method="POST" enctype="application/x-www-form-urlencoded" hx-post="/api/credentials" hx-target="#form-response-aws" hx-swap="innerHTML" hx-indicator="#loading-aws" hx-boost="false">
                        <input type="hidden" name="provider" value="aws">
                        <div id="form-response-aws"></div>
                        <div id="loading-aws" class="htmx-indicator">
                            <div class="spinner"></div>
                            <p>Saving credentials...</p>
                        </div>

                        <div class="form-section">
                            <h2>AWS Credentials</h2>
                            <div class="info-box">
                                <p>AWS provider support coming soon.</p>
                            </div>
                            
                            <!-- AWS fields will be added here when implemented
                            <div class="form-group">
                                <label for="aws_access_key_id">Access Key ID *</label>
                                <input type="password" id="aws_access_key_id" name="aws_access_key_id" required>
                                <small>Your AWS access key ID</small>
                            </div>

                            <div class="form-group">
                                <label for="aws_secret_access_key">Secret Access Key *</label>
                                <input type="password" id="aws_secret_access_key" name="aws_secret_access_key" required>
                                <small>Your AWS secret access key</small>
                            </div>

                            <div class="form-group">
                                <label for="aws_region">Region *</label>
                                <select id="aws_region" name="aws_region" required>
                                    <option value="us-east-1">us-east-1 (N. Virginia)</option>
                                    <option value="us-west-2">us-west-2 (Oregon)</option>
                                    <option value="eu-west-1">eu-west-1 (Ireland)</option>
                                    <option value="eu-central-1">eu-central-1 (Frankfurt)</option>
                                </select>
                                <small>Select your AWS region</small>
                            </div>
                            -->
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary" disabled>
                                <span class="btn-icon">üíæ</span> Save Credentials
                            </button>
                            <button type="button" id="btn-check-aws" class="btn btn-secondary" onclick="checkCredentials('aws')" disabled>
                                <span class="btn-icon">‚úì</span> Check Status
                            </button>
                        </div>
                    </form>

                    <div id="status-container-aws" class="status-container" style="display: none;">
                        <h3>Current Status</h3>
                        <div id="status-content-aws"></div>
                    </div>
                </div>

                <!-- Azure Provider Section (Future) -->
                <div id="provider-section-azure" class="provider-section" style="display: none;">
                    <div class="form-section">
                        <h2>Azure Credentials</h2>
                        <div class="info-box">
                            <p>Azure provider support coming soon.</p>
                        </div>
                    </div>
                </div>

                <!-- GCP Provider Section (Future) -->
                <div id="provider-section-gcp" class="provider-section" style="display: none;">
                    <div class="form-section">
                        <h2>Google Cloud Credentials</h2>
                        <div class="info-box">
                            <p>Google Cloud Platform provider support coming soon.</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Provider configuration - extensible for future providers
        const providerConfig = {
            ovh: {
                name: "OVHcloud",
                enabled: true,
                statusFields: ['service_name', 'endpoint']
            },
            aws: {
                name: "Amazon Web Services",
                enabled: false,
                statusFields: ['region']
            },
            azure: {
                name: "Microsoft Azure",
                enabled: false,
                statusFields: []
            },
            gcp: {
                name: "Google Cloud Platform",
                enabled: false,
                statusFields: []
            }
        };

        // Current selected provider
        let currentProvider = 'ovh';

        // Switch provider section visibility
        function switchProvider() {
            const providerSelect = document.getElementById('provider-select');
            const newProvider = providerSelect.value;
            
            // Hide all provider sections
            document.querySelectorAll('.provider-section').forEach(section => {
                section.style.display = 'none';
            });
            
            // Show selected provider section
            const selectedSection = document.getElementById(`provider-section-${newProvider}`);
            if (selectedSection) {
                selectedSection.style.display = 'block';
            }
            
            currentProvider = newProvider;
            
            // Check credentials for the selected provider
            checkCredentials(newProvider);
        }

        // Check credentials status for a specific provider
        function checkCredentials(provider) {
            const statusContainer = document.getElementById(`status-container-${provider}`);
            const statusContent = document.getElementById(`status-content-${provider}`);
            
            if (!statusContainer || !statusContent) return;
            
            statusContainer.style.display = 'block';
            statusContent.innerHTML = '<p>Checking...</p>';
            
            fetch(`/api/credentials?provider=${provider}`)
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else if (response.status === 404) {
                        return { configured: false };
                    }
                    throw new Error('Failed to check credentials');
                })
                .then(data => {
                    if (data.configured) {
                        let statusHTML = `
                            <div class="success-message">
                                <h4>‚úÖ Credentials Configured</h4>
                                <p>${providerConfig[provider]?.name || provider} credentials are stored in memory and ready to use.</p>
                                <ul>`;
                        
                        // Display provider-specific status fields
                        const fields = providerConfig[provider]?.statusFields || [];
                        fields.forEach(field => {
                            if (data[field]) {
                                const label = field.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                                statusHTML += `<li>${label}: <strong>${data[field]}</strong></li>`;
                            }
                        });
                        
                        statusHTML += `
                                </ul>
                                <p><small>Note: Credentials are stored in memory only and will be cleared on application restart.</small></p>
                            </div>`;
                        statusContent.innerHTML = statusHTML;
                    } else {
                        statusContent.innerHTML = `
                            <div class="error-message">
                                <h4>‚ö†Ô∏è No Credentials Configured</h4>
                                <p>Please configure your ${providerConfig[provider]?.name || provider} credentials above before creating labs.</p>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    statusContent.innerHTML = `
                        <div class="error-message">
                            <h4>‚ùå Error</h4>
                            <p>${error.message}</p>
                        </div>
                    `;
                });
        }

        // Load current credentials into form if they exist
        function loadCurrentCredentials(provider) {
            fetch(`/api/credentials?provider=${provider}`)
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    }
                    return { configured: false };
                })
                .then(data => {
                    if (data.configured) {
                        // Pre-fill non-sensitive fields based on provider
                        if (provider === 'ovh') {
                            const serviceNameInput = document.getElementById('ovh_service_name');
                            const endpointSelect = document.getElementById('ovh_endpoint');
                            
                            if (serviceNameInput && data.service_name) {
                                serviceNameInput.value = data.service_name;
                            }
                            
                            if (endpointSelect && data.endpoint) {
                                endpointSelect.value = data.endpoint;
                            }
                        }
                        // Future: Add handling for other providers here
                        
                        // Show info that credentials exist
                        const formSection = document.querySelector(`#provider-section-${provider} .form-section`);
                        if (formSection && !formSection.querySelector('.existing-creds-info')) {
                            const existingInfo = document.createElement('div');
                            existingInfo.className = 'info-box existing-creds-info';
                            existingInfo.style.marginBottom = '1.5rem';
                            
                            let infoHTML = `<h3>üìù Update Existing Credentials</h3>
                                <p>Credentials are currently configured. Fill in the fields below to update them.</p>`;
                            
                            if (provider === 'ovh') {
                                infoHTML += `<p><strong>Service Name:</strong> ${data.service_name || 'N/A'}</p>
                                    <p><strong>Endpoint:</strong> ${data.endpoint || 'N/A'}</p>`;
                            }
                            
                            existingInfo.innerHTML = infoHTML;
                            formSection.insertBefore(existingInfo, formSection.firstChild.nextSibling);
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading credentials:', error);
                });
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Check URL parameters for provider selection
            const urlParams = new URLSearchParams(window.location.search);
            const providerParam = urlParams.get('provider');
            
            if (providerParam && providerConfig[providerParam]) {
                document.getElementById('provider-select').value = providerParam;
                currentProvider = providerParam;
            }
            
            // Initialize provider view
            switchProvider();
            
            // Load current credentials for the selected provider
            loadCurrentCredentials(currentProvider);
        });

        // Handle form submission success
        document.body.addEventListener('htmx:afterSwap', function(event) {
            const targetId = event.detail.target.id;
            if (targetId.startsWith('form-response-')) {
                const provider = targetId.replace('form-response-', '');
                const response = event.detail.target;
                const responseText = response.innerHTML.toLowerCase();
                if (responseText.includes('success') || responseText.includes('saved successfully')) {
                    // Refresh status after successful save
                    setTimeout(() => checkCredentials(provider), 500);
                    // Clear form fields after successful save
                    const form = document.getElementById(`credentials-form-${provider}`);
                    if (form) {
                        // Only clear password fields, keep non-sensitive fields
                        form.querySelectorAll('input[type="password"]').forEach(input => {
                            input.value = '';
                        });
                    }
                }
            }
        });

        // Handle HTMX errors
        document.body.addEventListener('htmx:responseError', function(event) {
            console.error('HTMX Error:', event.detail);
            const targetId = event.detail.target?.id;
            if (targetId && targetId.startsWith('form-response-')) {
                const responseDiv = event.detail.target;
                if (responseDiv) {
                    responseDiv.innerHTML = `
                        <div class="error-message">
                            <h3>Error</h3>
                            <p>Failed to save credentials. Please check the server logs for details.</p>
                        </div>
                    `;
                }
            }
            event.preventDefault();
            return false;
        });

        // Fallback form submission if HTMX is not available
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('form[id^="credentials-form-"]').forEach(form => {
                form.addEventListener('submit', function(e) {
                    // If HTMX is not loaded, use fallback submission
                    if (typeof htmx === 'undefined') {
                        e.preventDefault();
                        
                        const provider = form.id.replace('credentials-form-', '');
                        const formData = new FormData(form);
                        const responseDiv = document.getElementById(`form-response-${provider}`);
                        const loadingDiv = document.getElementById(`loading-${provider}`);
                        
                        // Show loading indicator
                        if (loadingDiv) {
                            loadingDiv.style.display = 'block';
                        }
                        
                        // Submit form via fetch
                        fetch('/api/credentials', {
                            method: 'POST',
                            body: formData
                        })
                        .then(response => response.text())
                        .then(html => {
                            if (responseDiv) {
                                responseDiv.innerHTML = html;
                            }
                            if (loadingDiv) {
                                loadingDiv.style.display = 'none';
                            }
                            
                            // Check if save was successful
                            const responseText = html.toLowerCase();
                            if (responseText.includes('success') || responseText.includes('saved successfully')) {
                                // Refresh status after successful save
                                setTimeout(() => checkCredentials(provider), 500);
                                // Clear password fields after successful save
                                form.querySelectorAll('input[type="password"]').forEach(input => {
                                    input.value = '';
                                });
                            }
                        })
                        .catch(error => {
                            console.error('Error submitting form:', error);
                            if (responseDiv) {
                                responseDiv.innerHTML = `
                                    <div class="error-message">
                                        <h3>Error</h3>
                                        <p>Failed to save credentials: ${error.message}</p>
                                    </div>
                                `;
                            }
                            if (loadingDiv) {
                                loadingDiv.style.display = 'none';
                            }
                        });
                        
                        return false;
                    }
                    // Let HTMX handle the submission if available
                });
            });
        });
    </script>
</body>
</html>
