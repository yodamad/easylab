{{define "title"}}Create New Lab{{end}}
{{define "body-class"}}{{end}}
{{define "head-extra"}}
<script src="https://cdn.jsdelivr.net/npm/htmx.org@2.0.0/dist/htmx.min.js" integrity="sha384-LAnQFtNXh8s0hn9mOc8bezfn16i4Zo4y3i4dMT8PtV9yip8jGehR3RxCJrmHV11d" crossorigin="anonymous"></script>
{{end}}

{{define "body"}}
    <div class="container">
        <header>
            <div class="header-content">
                <div class="header-title">
                    <img src="/static/logo.png" alt="EasyLab Logo" class="header-logo">
                    <div>
                        <h1>EasyLab</h1>
                        <p class="subtitle">Create a new lab environment</p>
                    </div>
                </div>
                <div class="header-actions">
                    <a href="/labs" class="header-btn" title="Labs History">
                        <span class="btn-icon">üìã</span>
                        <span class="btn-text">Labs</span>
                    </a>
                    <a href="/credentials" class="header-btn" title="Provider Credentials">
                        <span class="btn-icon">üîê</span>
                        <span class="btn-text">Credentials</span>
                    </a>
                    <a href="/logout" class="logout-btn" title="Logout">
                        <span class="logout-icon">üö™</span>
                        <span class="logout-text">Logout</span>
                    </a>
                </div>
            </div>
        </header>

        <main>
            <!-- Progress Indicator -->
            <div class="wizard-progress">
                <div class="progress-step active" data-step="1">
                    <span class="step-number">1</span>
                    <span class="step-label">Provider</span>
                </div>
                <div class="progress-step" data-step="2">
                    <span class="step-number">2</span>
                    <span class="step-label">Pulumi</span>
                </div>
                <div class="progress-step" data-step="3">
                    <span class="step-number">3</span>
                    <span class="step-label">Network</span>
                </div>
                <div class="progress-step" data-step="4">
                    <span class="step-number">4</span>
                    <span class="step-label">Kubernetes</span>
                </div>
                <div class="progress-step" data-step="5">
                    <span class="step-number">5</span>
                    <span class="step-label">Node Pool</span>
                </div>
                <div class="progress-step" data-step="6">
                    <span class="step-number">6</span>
                    <span class="step-label">Coder</span>
                </div>
            </div>

            <!-- Provider Credentials Notice -->
            <div id="provider-credentials-notice" class="info-box" style="margin-bottom: 2rem; display: none;">
                <h3>üîê Provider Credentials Required</h3>
                <p>Before creating a lab, please configure your cloud provider API credentials. These credentials will be stored in memory and reused for all lab deployments.</p>
                <a href="/credentials" class="btn btn-primary">
                    <span class="btn-icon">‚öôÔ∏è</span> Configure Credentials
                </a>
            </div>

            <form id="lab-form" action="/api/labs" method="POST" enctype="multipart/form-data" hx-post="/api/labs" hx-target="#form-response" hx-swap="innerHTML" hx-indicator="#loading">
                <input type="hidden" id="dry-run-mode" name="dry_run" value="false">
                <div id="form-response"></div>
                <div id="loading" class="htmx-indicator">
                    <div class="spinner"></div>
                    <p>Submitting...</p>
                </div>

                <!-- Step 1: Infrastructure Mode -->
                <section class="wizard-step active" data-step="1">
                    <div class="step-header">
                        <h2>Infrastructure</h2>
                        <p class="section-description">Choose how to provide the Kubernetes cluster</p>
                    </div>
                    <div class="step-content">
                        <input type="hidden" id="use_existing_cluster" name="use_existing_cluster" value="false">

                        <div class="form-group">
                            <label>Cluster Mode *</label>
                            <div class="button-group">
                                <button type="button" class="source-button" data-cluster-mode="new" id="cluster-mode-new">
                                    <span class="source-icon">&#9729;</span>
                                    <div class="source-content">
                                        <span class="source-title">Create New Infrastructure</span>
                                        <span class="source-description">Provision a new Kubernetes cluster on a cloud provider</span>
                                    </div>
                                </button>
                                <button type="button" class="source-button" data-cluster-mode="existing" id="cluster-mode-existing">
                                    <span class="source-icon">&#9881;</span>
                                    <div class="source-content">
                                        <span class="source-title">Use Existing Cluster</span>
                                        <span class="source-description">Provide a kubeconfig for an existing Kubernetes cluster</span>
                                    </div>
                                </button>
                            </div>
                        </div>

                        <!-- Provider selection (shown for new infrastructure) -->
                        <div id="provider-section" style="display: none;">
                            <div class="form-group">
                                <label for="provider">Cloud Provider *</label>
                                <select id="provider" name="provider">
                                    <option value="ovh" selected>OVHcloud</option>
                                    <!-- Future providers can be added here:
                                    <option value="aws">Amazon Web Services (AWS)</option>
                                    <option value="azure">Microsoft Azure</option>
                                    <option value="gcp">Google Cloud Platform (GCP)</option>
                                    -->
                                </select>
                                <small>Choose the cloud provider for your infrastructure deployment</small>
                            </div>
                        </div>

                        <!-- Kubeconfig input (shown for existing cluster) -->
                        <div id="kubeconfig-section" style="display: none;">
                            <div class="form-group">
                                <label>Provide Kubeconfig *</label>
                                <div class="button-group">
                                    <button type="button" class="source-button" data-kubeconfig-mode="upload" id="kubeconfig-mode-upload">
                                        <span class="source-icon">&#128196;</span>
                                        <div class="source-content">
                                            <span class="source-title">Upload File</span>
                                            <span class="source-description">Upload a .yaml or .yml kubeconfig file</span>
                                        </div>
                                    </button>
                                    <button type="button" class="source-button" data-kubeconfig-mode="paste" id="kubeconfig-mode-paste">
                                        <span class="source-icon">&#128203;</span>
                                        <div class="source-content">
                                            <span class="source-title">Paste Content</span>
                                            <span class="source-description">Paste your kubeconfig YAML directly</span>
                                        </div>
                                    </button>
                                </div>
                            </div>

                            <div id="kubeconfig-upload-section" style="display: none;">
                                <div class="form-group">
                                    <label for="kubeconfig_file">Kubeconfig File</label>
                                    <div class="file-upload-wrapper">
                                        <input type="file" id="kubeconfig_file" name="kubeconfig_file" accept=".yaml,.yml,.conf,.config" class="file-input">
                                        <label for="kubeconfig_file" class="file-upload-label">
                                            <span class="file-upload-icon">&#128196;</span>
                                            <span class="file-upload-text">Choose file or drag it here</span>
                                            <span class="file-upload-button">Browse</span>
                                        </label>
                                        <div class="file-name-display" id="kubeconfig-file-name-display"></div>
                                    </div>
                                    <small>Upload a .yaml or .yml kubeconfig file</small>
                                </div>
                            </div>

                            <div id="kubeconfig-paste-section" style="display: none;">
                                <div class="form-group">
                                    <label for="kubeconfig_content">Kubeconfig Content</label>
                                    <textarea id="kubeconfig_content" name="kubeconfig_content" rows="10" class="monospace" placeholder="apiVersion: v1&#10;kind: Config&#10;clusters:&#10;- cluster:&#10;    server: https://...&#10;  name: my-cluster&#10;..."></textarea>
                                    <small>Paste your kubeconfig YAML content directly</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Step 2: Pulumi Configuration -->
                <section class="wizard-step" data-step="2">
                    <div class="step-header">
                        <h2>Pulumi Configuration</h2>
                        <p class="section-description">Configure your Pulumi stack settings</p>
                    </div>
                    <div class="step-content">
                        <div class="form-group">
                            <label for="stack_name">Stack Name *</label>
                            <input type="text" id="stack_name" name="stack_name" value="dev" required pattern="[a-zA-Z0-9_-]+" title="Only letters, numbers, hyphens and underscores allowed">
                            <small>Unique name for this deployment (e.g., dev, prod, test-lab-1)</small>
                        </div>
                    </div>
                </section>

                <!-- Step 3: Network Configuration -->
                <section class="wizard-step" data-step="3">
                    <div class="step-header">
                        <h2>Network Configuration</h2>
                        <p class="section-description">Configure private network and gateway settings</p>
                    </div>
                    <div class="step-content">
                        <div class="form-group">
                            <label for="network_gateway_name">Gateway Name *</label>
                            <input type="text" id="network_gateway_name" name="network_gateway_name" value="dev-gateway" required data-base-name="gateway">
                        </div>

                        <div class="form-group">
                            <label for="network_gateway_model">Gateway Model *</label>
                            <select id="network_gateway_model" name="network_gateway_model" required>
                                <option value="s" selected>s (Small)</option>
                                <option value="m">m (Medium)</option>
                                <option value="l">l (Large)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="network_private_network_name">Private Network Name *</label>
                            <input type="text" id="network_private_network_name" name="network_private_network_name" value="dev-network" required data-base-name="network">
                        </div>

                        <div class="form-group">
                            <label for="network_id">Network ID</label>
                            <input type="text" id="network_id" name="network_id" placeholder="New network ID" required>
                        </div>

                        <div class="form-group">
                            <label for="network_region">Region *</label>
                            <select id="network_region" name="network_region" required>
                                <option value="GRA9" selected>GRA9</option>
                                <option value="GRA11">GRA11</option>
                                <option value="SBG5">SBG5</option>
                                <option value="BHS5">BHS5</option>
                                <option value="WAW1">WAW1</option>
                                <option value="DE1">DE1</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="network_mask">Network Mask (CIDR) *</label>
                            <input type="text" id="network_mask" name="network_mask" value="10.0.0.0/24" required>
                            <small>e.g., 10.0.0.0/24</small>
                            <div id="network-calculated-info" class="calculated-info" style="margin-top: 0.75rem; padding: 0.75rem; background: var(--surface); border-radius: var(--radius); border: 1px solid var(--border);">
                                <div style="font-size: 0.875rem; color: var(--text-light);">
                                    <div><strong>Start IP:</strong> <span id="calculated-start-ip">10.0.0.100</span></div>
                                    <div style="margin-top: 0.5rem;"><strong>End IP:</strong> <span id="calculated-end-ip">10.0.0.254</span></div>
                                </div>
                            </div>
                            <!-- Hidden fields to submit calculated values -->
                            <input type="hidden" id="network_start_ip" name="network_start_ip" value="10.0.0.100">
                            <input type="hidden" id="network_end_ip" name="network_end_ip" value="10.0.0.254">
                        </div>

                    </div>
                </section>

                <!-- Step 4: Kubernetes Configuration -->
                <section class="wizard-step" data-step="4">
                    <div class="step-header">
                        <h2>Kubernetes Configuration</h2>
                        <p class="section-description">Configure your managed Kubernetes cluster</p>
                    </div>
                    <div class="step-content">
                        <div class="form-group">
                            <label for="k8s_cluster_name">Cluster Name *</label>
                            <input type="text" id="k8s_cluster_name" name="k8s_cluster_name" value="dev-cluster" required data-base-name="cluster">
                        </div>
                    </div>
                </section>

                <!-- Step 5: Node Pool Configuration -->
                <section class="wizard-step" data-step="5">
                    <div class="step-header">
                        <h2>Node Pool Configuration</h2>
                        <p class="section-description">Configure Kubernetes node pool settings</p>
                    </div>
                    <div class="step-content">
                        <div class="form-group">
                            <label for="nodepool_name">Node Pool Name *</label>
                            <input type="text" id="nodepool_name" name="nodepool_name" value="dev-nodepool" required data-base-name="nodepool">
                        </div>

                        <div class="form-group">
                            <label for="nodepool_flavor">Flavor *</label>
                            <select id="nodepool_flavor" name="nodepool_flavor" required>
                                <option value="d2-8" selected>d2-8</option>
                                <option value="b2-120">b2-120</option>
                                <option value="b3-128">b3-128</option>
                                <option value="b3-256">b3-256</option>
                            </select>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="nodepool_desired_node_count">Desired Nodes *</label>
                                <input type="number" id="nodepool_desired_node_count" name="nodepool_desired_node_count" value="1" min="1" required>
                            </div>

                            <div class="form-group">
                                <label for="nodepool_min_node_count">Min Nodes *</label>
                                <input type="number" id="nodepool_min_node_count" name="nodepool_min_node_count" value="1" min="1" required>
                            </div>

                            <div class="form-group">
                                <label for="nodepool_max_node_count">Max Nodes *</label>
                                <input type="number" id="nodepool_max_node_count" name="nodepool_max_node_count" value="2" min="1" required>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Step 6: Coder Configuration -->
                <section class="wizard-step" data-step="6">
                    <div class="step-header">
                        <h2>Coder Configuration</h2>
                        <p class="section-description">Configure the Coder IDE platform</p>
                    </div>
                    <div class="step-content">
                        <div class="form-group">
                            <label for="coder_admin_email">Admin Email *</label>
                            <input type="email" id="coder_admin_email" name="coder_admin_email" value="admin@coder.com" required>
                        </div>

                        <div class="form-group">
                            <label for="coder_admin_password">Admin Password *</label>
                            <input type="password" id="coder_admin_password" name="coder_admin_password" required>
                            <small>Strong password required</small>
                        </div>

                        <div class="form-group">
                            <label for="coder_version">Coder Version *</label>
                            <input type="text" id="coder_version" name="coder_version" value="2.29.1" required>
                        </div>

                        <div class="form-group">
                            <label for="coder_template_name">Template Name *</label>
                            <input type="text" id="coder_template_name" name="coder_template_name" value="docker-template" required>
                        </div>

                        <div class="form-group">
                            <label>Template Source *</label>
                            <div class="button-group">
                                <!-- Hidden radio inputs for form submission -->
                                <input type="radio" name="template_source" value="upload" id="template_source_upload" style="display: none;">
                                <input type="radio" name="template_source" value="git" id="template_source_git" style="display: none;">
                                
                                <button type="button" class="source-button" data-source="upload" id="source-button-upload">
                                    <span class="source-icon">üìÅ</span>
                                    <div class="source-content">
                                        <span class="source-title">Upload File</span>
                                        <span class="source-description">Upload a template file</span>
                                    </div>
                                </button>
                                
                                <button type="button" class="source-button" data-source="git" id="source-button-git">
                                    <span class="source-icon">üîó</span>
                                    <div class="source-content">
                                        <span class="source-title">Git Repository</span>
                                        <span class="source-description">Use template from Git</span>
                                    </div>
                                </button>
                            </div>
                            <small>Choose how you want to provide the template</small>
                        </div>

                        <div id="template_upload_section" class="template-source-section" style="display: none;">
                            <div class="form-group">
                                <label for="template_file">Template File *</label>
                                <div class="file-upload-wrapper">
                                    <input type="file" id="template_file" name="template_file" accept=".zip,.tf" class="file-input">
                                    <label for="template_file" class="file-upload-label">
                                        <span class="file-upload-icon">üìÅ</span>
                                        <span class="file-upload-text">Choose file or drag it here</span>
                                        <span class="file-upload-button">Browse</span>
                                    </label>
                                    <div class="file-name-display" id="file-name-display"></div>
                                </div>
                                <small>Upload a template file (.zip or .tf)</small>
                            </div>
                        </div>

                        <div id="template_git_section" class="template-source-section" style="display: none;">
                            <div class="form-group">
                                <label for="template_git_repo">Repository URL *</label>
                                <input type="text" id="template_git_repo" name="template_git_repo" placeholder="https://gitlab.com/user/repo.git">
                                <small>Git repository URL containing the template files</small>
                            </div>
                            <div class="form-group">
                                <label for="template_git_folder">Folder Path (Optional)</label>
                                <input type="text" id="template_git_folder" name="template_git_folder" placeholder="Leave empty for repository root">
                                <small>Path to folder containing template files. Leave empty to use repository root.</small>
                            </div>
                            <div class="form-group">
                                <label for="template_git_branch">Branch (Optional)</label>
                                <input type="text" id="template_git_branch" name="template_git_branch" value="main" placeholder="main">
                                <small>Git branch to use. Defaults to "main" if not specified.</small>
                            </div>
                        </div>

                        <h3 class="subsection-title">Database Configuration</h3>
                        
                        <div class="form-group">
                            <label for="coder_db_user">Database User *</label>
                            <input type="text" id="coder_db_user" name="coder_db_user" value="coder" required>
                        </div>

                        <div class="form-group">
                            <label for="coder_db_password">Database Password *</label>
                            <input type="password" id="coder_db_password" name="coder_db_password" required>
                        </div>

                        <div class="form-group">
                            <label for="coder_db_name">Database Name *</label>
                            <input type="text" id="coder_db_name" name="coder_db_name" value="coderdb" required>
                        </div>
                    </div>
                </section>
            </form>

            <!-- Sticky Footer Navigation -->
            <div class="wizard-footer">
                <div class="footer-content">
                    <button type="button" id="btn-prev" class="btn btn-secondary" disabled>
                        <span class="btn-icon">‚Üê</span> Previous
                    </button>
                    <div class="step-indicator">
                        Step <span id="current-step-num">1</span> of <span id="total-steps">6</span>
                    </div>
                    <button type="button" id="btn-next" class="btn btn-primary">
                        Next <span class="btn-icon">‚Üí</span>
                    </button>
                    <button type="button" id="btn-dry-run" form="lab-form" class="btn btn-secondary" style="display: none;">
                        <span class="btn-icon">üîç</span> Dry Run
                    </button>
                    <button type="submit" id="btn-submit" form="lab-form" class="btn btn-success" style="display: none;">
                        Create Lab
                    </button>
                </div>
            </div>

            <!-- Job Status Display Area -->
            <div id="job-status-container" class="job-status-container"></div>
        </main>
    </div>

    <script src="/static/admin.js"></script>
{{end}}

