# GitLab CI/CD Pipeline
# 
# This pipeline builds and publishes Docker images to Docker Hub.
# 
# Required GitLab CI/CD Variables (set in Project Settings > CI/CD > Variables):
#   - DOCKER_REGISTRY_USER: Docker Hub username
#   - DOCKER_REGISTRY_PASSWORD: Docker Hub password or access token (masked, protected)
#
# Image Tagging Strategy:
#   - Tagged as "dev" for branch commits
#   - Tagged with Git tag name for Git tag commits (e.g., v1.0.0)

variables:
  GO_VERSION: "1.26"
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  IMAGE_NAME: "docker.io/${DOCKER_REGISTRY_USER}/easylab"
  # for zensical
  # GitLab CI creates a separate mountpoint for the build directory,
  # so we need to copy instead of using hard links.
  UV_LINK_MODE: copy  

stages:
  - build
  - test
  - package
  - security
  - deploy
  - publish

# Reusable image tag computation (dev for branches, tag name for tags)
.image-tag:
  before_script:
    - |
      if [ -n "$CI_COMMIT_TAG" ]; then
        export IMAGE_TAG="$CI_COMMIT_REF_NAME"
      else
        export IMAGE_TAG="dev"
      fi

# Base job for Go jobs with module caching
.go-base:
  image: golang:${GO_VERSION}
  variables:
    GOMODCACHE: ${CI_PROJECT_DIR}/.go-mod-cache
  before_script:
    - go version
    - go mod download
    - go mod verify
  cache:
    key: go-modules-${CI_COMMIT_REF_SLUG}
    paths:
      - .go-mod-cache/
    policy: pull-push

# Build a static Linux binary for Docker
build:
  extends: .go-base
  stage: build
  script:
    - CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o main ./cmd/server
  artifacts:
    paths:
      - main
      - web/
      - templates/
    expire_in: 1 hour

# Run Go tests (starts immediately, parallel with build)
test:
  extends: .go-base
  stage: test
  needs: []
  script:
    - mkdir -p reports
    - go test -v -race -coverprofile=coverage.out ./...
    - go tool cover -func=coverage.out
  coverage: '/total:\s+\(statements\)\s+\d+\.\d+%/'
  artifacts:
    paths:
      - coverage.out
      - reports/
    expire_in: 1 week
    when: always

# Lint Dockerfile with Hadolint
hadolint:
  stage: test
  needs: []
  image: hadolint/hadolint:latest-alpine
  script:
    - hadolint Dockerfile
  allow_failure: false

# Build Docker image (reuses pre-built binary via SKIP_BUILD arg)
docker-build:
  stage: package
  image: docker:24
  services:
    - docker:24-dind
  needs:
    - job: build
      artifacts: true
    - job: test
      artifacts: false
    - job: hadolint
      artifacts: false
  before_script:
    - !reference [.image-tag, before_script]
    - echo "Building Docker image ${IMAGE_NAME}:${IMAGE_TAG}"
  script:
    - docker build --build-arg SKIP_BUILD=true -t ${IMAGE_NAME}:${IMAGE_TAG} .
    - docker save ${IMAGE_NAME}:${IMAGE_TAG} -o image.tar
  artifacts:
    paths:
      - image.tar
    expire_in: 1 hour
  only:
    - branches
    - tags
  tags:
    - docker

# Security scan with Trivy
trivy-scan:
  stage: security
  image: aquasec/trivy:latest
  needs:
    - job: docker-build
      artifacts: true
  before_script:
    - !reference [.image-tag, before_script]
  script: |
    trivy image --input image.tar --exit-code 0 --severity HIGH,CRITICAL --format table
    trivy image --input image.tar --exit-code 0 --severity HIGH,CRITICAL --format json --output gl-container-scanning-report.json || true
  artifacts:
    reports:
      container_scanning: gl-container-scanning-report.json
    paths:
      - gl-container-scanning-report.json
    expire_in: 1 week
    when: always
  allow_failure: true
  only:
    - branches
    - tags

# Push Docker image to Docker Hub
docker-push:
  stage: deploy
  image: docker:24
  services:
    - docker:24-dind
  needs:
    - job: docker-build
      artifacts: true
    - job: trivy-scan
      artifacts: false
  before_script:
    - !reference [.image-tag, before_script]
    - echo "Pushing Docker image ${IMAGE_NAME}:${IMAGE_TAG}"
    - docker load -i image.tar
    - echo "$DOCKER_REGISTRY_PASSWORD" | docker login -u "$DOCKER_REGISTRY_USER" --password-stdin
  script:
    - docker push ${IMAGE_NAME}:${IMAGE_TAG}
  after_script:
    - docker logout
  only:
    - branches
    - tags
  tags:
    - docker

goreleaser:
  stage: publish
  image:
    name: goreleaser/goreleaser
    entrypoint: [""]
  only:
    - tags
  variables:
    GIT_DEPTH: 0
  script:
    - goreleaser release --clean -f .goreleaser.gitlab.yaml

# Update Docker Hub repository overview (README) from README.md
dockerhub-readme:
  stage: publish
  image: peterevans/dockerhub-description:3
  variables:
    DOCKERHUB_USERNAME: $DOCKER_REGISTRY_USER
    DOCKERHUB_PASSWORD: $DOCKER_REGISTRY_PASSWORD
    DOCKERHUB_REPOSITORY: "${DOCKER_REGISTRY_USER}/easylab"
    README_FILEPATH: "README.md"
  script:
    - node /index.js
  needs:
    - docker-push
  only:
    - main
    - tags

pages:
  stage: publish
  image: ghcr.io/astral-sh/uv:0.10.2-python3.12-alpine
  script:
    - uv add --dev zensical
    - uv run zensical build
  needs: []
  artifacts:
    paths:
      - site
  publish: site
