# GitLab CI/CD Pipeline
# 
# This pipeline builds and publishes Docker images to Docker Hub.
# 
# Required GitLab CI/CD Variables (set in Project Settings > CI/CD > Variables):
#   - DOCKER_REGISTRY_USER: Docker Hub username
#   - DOCKER_REGISTRY_PASSWORD: Docker Hub password or access token (masked, protected)
#
# Image Tagging Strategy:
#   - Tagged as "dev" for branch commits
#   - Tagged with Git tag name for Git tag commits (e.g., v1.0.0)

variables:
  GO_VERSION: "1.26"
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  IMAGE_NAME: "docker.io/${DOCKER_REGISTRY_USER}/easylab"
  # for zensical
  # GitLab CI creates a separate mountpoint for the build directory,
  # so we need to copy instead of using hard links.
  UV_LINK_MODE: copy  

stages:
  - build
  - test
  - package
  - security
  - deploy
  - publish

# Base job for Go jobs
.go-base:
  image: golang:${GO_VERSION}
  before_script:
    - go version
    - go mod download
    - go mod verify

# Build the Go application
build:
  extends: .go-base
  stage: build
  script:
    - echo "Building EasyLab server..."
    - go build -v ./cmd/server
    - echo "Build completed successfully"
  artifacts:
    paths:
      - cmd/server/
    expire_in: 1 hour

# Run Go tests
test:
  extends: .go-base
  stage: test
  script:
    - echo "Running Go tests with race detector..."
    - mkdir -p reports
    - go test -v -race -coverprofile=coverage.out ./...
    - go tool cover -func=coverage.out
    - echo "Tests completed successfully"
  coverage: '/total:\s+\(statements\)\s+\d+\.\d+%/'
  artifacts:
    paths:
      - coverage.out
      - reports/
    expire_in: 1 week
    when: always

# Lint Dockerfile with Hadolint
hadolint:
  stage: test
  image: hadolint/hadolint:latest-alpine
  script:
    - echo "Linting Dockerfile with Hadolint..."
    - hadolint Dockerfile
    - echo "Dockerfile linting completed"
  allow_failure: false

# Build Docker image
docker-build:
  stage: package
  image: docker:24-dind
  services:
    - docker:24-dind
  dependencies:
    - build
    - test
  before_script: |
      # Compute image tag: use Git tag name if available, otherwise "dev"
      if [ -n "$CI_COMMIT_TAG" ]; then
        export IMAGE_TAG="$CI_COMMIT_REF_NAME"
        echo "Building release image with tag: $IMAGE_TAG"
      else
        export IMAGE_TAG="dev"
        echo "Building dev image with tag: $IMAGE_TAG"
      fi
      echo "Building Docker image: ${IMAGE_NAME}:${IMAGE_TAG}"
  script:
    - docker build -t ${IMAGE_NAME}:${IMAGE_TAG} .
    - echo "Saving image for Trivy scanning..."
    - docker save ${IMAGE_NAME}:${IMAGE_TAG} -o image.tar
    - echo "Docker image built successfully"
  artifacts:
    paths:
      - image.tar
    expire_in: 1 hour
  only:
    - branches
    - tags

# Security scan with Trivy
trivy-scan:
  stage: security
  image: aquasec/trivy:latest
  dependencies:
    - docker-build
  before_script: |
      # Compute image tag: use Git tag name if available, otherwise "dev"
      if [ -n "$CI_COMMIT_TAG" ]; then
        export IMAGE_TAG="$CI_COMMIT_REF_NAME"
      else
        export IMAGE_TAG="dev"
      fi
  script: |
    echo "Scanning Docker image for vulnerabilities: ${IMAGE_NAME}:${IMAGE_TAG}"
    trivy image --input image.tar --exit-code 0 --severity HIGH,CRITICAL --format table
    trivy image --input image.tar --exit-code 0 --severity HIGH,CRITICAL --format json --output gl-container-scanning-report.json || true
    echo "Security scan completed"
  artifacts:
    reports:
      container_scanning: gl-container-scanning-report.json
    paths:
      - gl-container-scanning-report.json
    expire_in: 1 week
    when: always
  allow_failure: true
  only:
    - branches
    - tags

# Push Docker image to Docker Hub
docker-push:
  stage: deploy
  image: docker:24-dind
  services:
    - docker:24-dind
  dependencies:
    - docker-build
    - trivy-scan
  before_script: |
    # Compute image tag: use Git tag name if available, otherwise "dev"
    if [ -n "$CI_COMMIT_TAG" ]; then
      export IMAGE_TAG="$CI_COMMIT_REF_NAME"
      echo "Pushing release image with tag: $IMAGE_TAG"
    else
      export IMAGE_TAG="dev"
      echo "Pushing dev image with tag: $IMAGE_TAG"
    fi
    echo "Loading Docker image from artifact..."
    docker load -i image.tar
    echo "Logging in to Docker Hub..."
    echo "$DOCKER_REGISTRY_PASSWORD" | docker login -u "$DOCKER_REGISTRY_USER" --password-stdin
    echo "Pushing Docker image: ${IMAGE_NAME}:${IMAGE_TAG}"
  script:
    - docker push ${IMAGE_NAME}:${IMAGE_TAG}
    - echo "Docker image pushed successfully"
  after_script:
    - docker logout
  only:
    - branches
    - tags
  tags:
    - docker

goreleaser:
  stage: publish
  image:
    name: goreleaser/goreleaser
    entrypoint: [""]
  only:
    - tags
  variables:
    # Disable shallow cloning so that goreleaser can diff between tags to
    # generate a changelog.
    GIT_DEPTH: 0
  script:
    - goreleaser release --clean -f .goreleaser.gitlab.yaml

# Update Docker Hub repository overview (README) from README.md
dockerhub-readme:
  stage: publish
  image: peterevans/dockerhub-description:3
  variables:
    DOCKERHUB_USERNAME: $DOCKER_REGISTRY_USER
    DOCKERHUB_PASSWORD: $DOCKER_REGISTRY_PASSWORD
    DOCKERHUB_REPOSITORY: "${DOCKER_REGISTRY_USER}/easylab"
    README_FILEPATH: "README.md"
  script:
    - node /index.js
  needs:
    - docker-push
  only:
    - main
    - tags

pages:
  stage: publish
  image: ghcr.io/astral-sh/uv:0.10.2-python3.12-alpine
  script:
    - uv add --dev zensical
    - uv run zensical build
  needs: []
  artifacts:
    paths:
      - site
  publish: site
